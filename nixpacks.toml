# ==============================================
# Nixpacks Configuration for Fayrelane
# Optimized for Railway deployment with monorepo structure
# ==============================================

[phases.setup]
# Use Node.js 18 (LTS) for compatibility
nixPkgs = ["nodejs_18"]

[phases.install]
# Install dependencies for both server and client
# This phase is cached by Nixpacks for faster subsequent builds
# Note: Using --prefix to avoid directory navigation issues in Docker layers
cmds = [
    "echo '📦 Installing server dependencies (production only)...'",
    "npm install --omit=dev --prefix ./server",
    "echo '✅ Server dependencies installed'",
    "echo '📦 Installing client dependencies...'",
    "npm install --prefix ./client",
    "echo '✅ Client dependencies installed'"
]

[phases.build]
# Build the Next.js client for production
# Server has no build step (runs directly with node)
cmds = [
    "echo '🏗️  Building Next.js client application...'",
    "npm run build --prefix ./client",
    "echo '✅ Client build complete!'"
]

[start]
# Start the Express server
# Server serves both API and built client in production
cmd = "cd server && node index.js"

