# ==============================================
# Nixpacks Configuration for Fayrelane
# Optimized for Railway deployment with monorepo structure
# ==============================================

[phases.setup]
# Use Node.js 18 (LTS) for compatibility
nixPkgs = ["nodejs_18"]

[phases.install]
# Install dependencies for both server and client
# This phase is cached by Nixpacks for faster subsequent builds
# Note: Using --prefix to avoid directory navigation issues in Docker layers
cmds = [
    "echo 'ğŸ“¦ Installing server dependencies (production only)...'",
    "npm install --omit=dev --prefix ./server",
    "echo 'âœ… Server dependencies installed'",
    "echo 'ğŸ“¦ Installing client dependencies...'",
    "npm install --prefix ./client",
    "echo 'âœ… Client dependencies installed'"
]

[phases.build]
# Build the Next.js client for production
# Server has no build step (runs directly with node)
cmds = [
    "echo 'ğŸ—ï¸  Building Next.js client application...'",
    "cd client && npm run build",
    "echo 'âœ… Client build complete!'",
    "echo 'ğŸ“ Checking build output...'",
    "ls -la client/out || echo 'No out directory found'",
    "ls -la client/.next || echo 'No .next directory found'"
]

[start]
# Start the Express server
# Server serves both API and built client in production
cmd = "cd server && node index.js"

